<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradious Loan App - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gradious-loan-app-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, auth, db;
        if (Object.keys(firebaseConfig).length > 0 && typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function') {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            if (initialAuthToken) { auth.signInWithCustomToken(initialAuthToken).then(() => { console.log("Firebase client signed in with custom token."); }).catch((error) => { console.error("Error signing in with custom token:", error); auth.signInAnonymously().then(() => console.log("Signed in anonymously.")).catch(e => console.error("Anon sign-in failed", e)); }); } else if (!auth.currentUser) { auth.signInAnonymously().then(() => { console.log("Firebase client signed in anonymously."); }).catch((error) => { console.error("Error signing in anonymously:", error); }); }
        } else { console.warn("Firebase config not found or SDK not loaded. Firebase features will not be available."); auth = { currentUser: { uid: 'anonymous-user', email: 'anonymous@example.com', getIdToken: async () => 'dummy-token' }, onAuthStateChanged: (callback) => { callback({ uid: 'anonymous-user', email: 'anonymous@example.com', getIdToken: async () => 'dummy-token' }); return () => {}; }, signOut: async () => { console.log("Dummy sign out"); return Promise.resolve(); }, signInWithEmailAndPassword: async (email, password) => { console.log("Dummy login"); return { user: { uid: 'dummy-user', email, getIdToken: async () => 'dummy-token' } }; }, createUserWithEmailAndPassword: async (email, password) => { console.log("Dummy signup"); return { user: { uid: 'dummy-user', email, getIdToken: async () => 'dummy-token' } }; } }; db = { collection: () => ({ doc: () => ({ set: async () => console.log("Dummy set"), get: async () => ({ data: () => ({}) }), collection: () => ({ add: async () => ({ id: 'dummy-id' }), get: async () => ({ docs: [] }), doc: () => ({ update: async () => console.log("Dummy update") }) }) }) }) }; }
        async function getIdToken() { if (auth.currentUser) { return await auth.currentUser.getIdToken(); } return null; }
        function getUserId() { return auth.currentUser ? auth.currentUser.uid : null; }
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="app-name">
            <span class="orange-G">G</span>radious Loan App - Admin
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="admin.html" class="active">Admin Panel</a></li>
            <li><a href="#" id="adminLogout">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="card" style="max-width: 900px; text-align: left;">
            <h2>ADMIN PAGE</h2>
            <div id="adminMessage" class="message" style="display: none; margin-bottom: 20px;"></div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Application ID</th>
                        <th>Type</th>
                        <th>Applied Date</th>
                        <th>Status</th>
                        <th>Repayment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminApplicationsTableBody">
                    <tr><td colspan="7" style="text-align: center;">Loading applications...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function fetchApplications() {
            const adminApplicationsTableBody = document.getElementById('adminApplicationsTableBody');
            const adminMessage = document.getElementById('adminMessage');
            adminApplicationsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading applications...</td></tr>';
            adminMessage.style.display = 'none';

            try {
                const idToken = await getIdToken();
                if (!idToken) {
                    throw new Error('Admin login required. Please log in.');
                }

                const response = await fetch('/api/admin/applications', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const applications = await response.json();

                if (response.ok) {
                    adminApplicationsTableBody.innerHTML = '';
                    if (applications.length === 0) {
                        adminApplicationsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No loan applications found.</td></tr>';
                    } else {
                        applications.forEach(app => {
                            const row = document.createElement('tr');
                            const appliedDate = app.appliedDate ? new Date(app.appliedDate._seconds * 1000).toLocaleDateString() : 'N/A';
                            const statusClass = app.status === 'Approved' ? 'status-approved' : '';
                            row.innerHTML = `
                                <td>${app.userId}</td>
                                <td>${app.applicationId || app.id}</td>
                                <td>${app.loanType}</td>
                                <td>${appliedDate}</td>
                                <td class="${statusClass}">${app.status}</td>
                                <td>${app.repayment || '-'}</td>
                                <td class="admin-actions">
                                    <button class="action-btn view-details" data-id="${app.applicationId || app.id}" data-user-id="${app.userId}">View</button>
                                    <button class="action-btn accept" data-id="${app.applicationId || app.id}" data-user-id="${app.userId}">ACCEPT</button>
                                    <button class="action-btn reject" data-id="${app.applicationId || app.id}" data-user-id="${app.userId}">REJECT</button>
                                </td>
                            `;
                            adminApplicationsTableBody.appendChild(row);
                        });

                        attachEventListeners(); // Attach event listeners after rendering
                    }
                } else {
                    adminMessage.textContent = applications.message || 'Failed to fetch admin applications.';
                    adminMessage.style.color = '#dc3545';
                    adminMessage.style.display = 'block';
                    adminApplicationsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading applications.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching admin applications:', error);
                adminMessage.textContent = error.message || 'An unexpected error occurred while fetching admin data.';
                adminMessage.style.color = '#dc3545';
                adminMessage.style.display = 'block';
                adminApplicationsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading applications.</td></tr>';
            }
        }

        async function updateApplicationStatus(appId, status, repayment = null) {
            const adminMessage = document.getElementById('adminMessage');
            adminMessage.style.display = 'none';

            try {
                const idToken = await getIdToken();
                if (!idToken) {
                    throw new Error('Authentication required.');
                }

                const response = await fetch(`/api/admin/applications/${appId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ status, repayment })
                });

                const data = await response.json();

                if (response.ok) {
                    adminMessage.textContent = data.message;
                    adminMessage.style.color = '#ff8c00';
                    adminMessage.style.display = 'block';
                    fetchApplications(); // Refresh the table
                } else {
                    adminMessage.textContent = data.message || 'Failed to update status.';
                    adminMessage.style.color = '#dc3545';
                    adminMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error updating application status:', error);
                adminMessage.textContent = error.message || 'An unexpected error occurred during update.';
                adminMessage.style.color = '#dc3545';
                adminMessage.style.display = 'block';
            }
        }

        function attachEventListeners() {
            document.querySelectorAll('.action-btn.accept').forEach(button => {
                button.onclick = null; // Clear previous listener
                button.onclick = () => {
                    const appId = button.dataset.id;
                    updateApplicationStatus(appId, 'Approved', 'N/A');
                };
            });

            document.querySelectorAll('.action-btn.reject').forEach(button => {
                button.onclick = null;
                button.onclick = () => {
                    const appId = button.dataset.id;
                    updateApplicationStatus(appId, 'Rejected', '-');
                };
            });

            document.querySelectorAll('.action-btn.view-details').forEach(button => {
                button.onclick = null;
                button.onclick = () => {
                    const appId = button.dataset.id;
                    const userId = button.dataset.userId;
                    alert(`Viewing details for Application ID: ${appId} (User ID: ${userId})\n\n(In a real app, this would open a modal with full application details including uploaded documents.)`);
                };
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    fetchApplications();
                } else {
                    document.getElementById('adminApplicationsTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center;">You must be logged in to view the Admin Panel.</td></tr>';
                    document.getElementById('adminMessage').textContent = 'Please log in with an admin account to access this page.';
                    document.getElementById('adminMessage').style.color = '#dc3545';
                    document.getElementById('adminMessage').style.display = 'block';
                }
            });

            document.getElementById('adminLogout').addEventListener('click', async (event) => {
                event.preventDefault();
                try {
                    await auth.signOut();
                    localStorage.removeItem('idToken');
                    localStorage.removeItem('userId');
                    alert('Logged out successfully!');
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out. Please try again.');
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentPath = window.location.pathname.split('/').pop();
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                const linkPath = link.href.split('/').pop();
                link.classList.remove('active');
                if (linkPath === currentPath || (currentPath === '' && linkPath === 'index.html')) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>